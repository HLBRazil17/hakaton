<section id="aluno-detalhes" class="container">
    <a href="http://localhost:8080/">
        < Voltar</a>
</section>

<script>
    // Obtendo a URL atual
    const url = window.location.href;

    // Usando o URLSearchParams para obter os parâmetros da URL
    const params = new URLSearchParams(new URL(url).search);

    // Obtendo o valor do parâmetro 'iduser'
    const alunoId = params.get('idUser');

    function getApiAluno() {
        // Fazer solicitação GET para obter dados do servidor PHP
        fetch(`http://localhost:8080/api/v1/getCurriculo.php?idUser=${alunoId}`, {
            method: 'GET',
            credentials: 'include'
        })
            .then(response => {
                return response.json();
            })
            .then(data => {
                console.log(data);
                renderAlunoDetalhes(data[0]);
                createCurriculosTable(data);
            })
            .catch(error => {
                console.error('Erro:', error);
            });
    }
    getApiAluno();

    // Função para renderizar os detalhes do aluno
    function renderAlunoDetalhes(aluno) {
        const alunoDetalhes = document.getElementById('aluno-detalhes');

        const alunoDiv = document.createElement('div');
        alunoDiv.className = 'aluno';

        const alunoContent = `
        <div class="form-group">
            <label>Nome:</label>
            <input type="text" value="${aluno.nome}" name="nome">
        </div>
        <div class="form-group">
            <label>Ra:</label>
            <input type="text" value="${aluno.ra}" name="ra">
        </div>
        <div class="form-group">
            <label>Email:</label>
            <input type="text" value="${aluno.email}" name="email">
        </div>
        <div class="form-group">
            <label>Telefone:</label>
            <input type="text" value="${aluno.telefone}" name="telefone">
        </div>
        <button>Enviar</button>
        `;

        alunoDiv.innerHTML = alunoContent;
        alunoDetalhes.appendChild(alunoDiv);
    }

    // Função para criar a tabela de currículos
    function createCurriculosTable(data) {
        const alunoDetalhes = document.getElementById('aluno-detalhes');
        const table = document.createElement('table');
        table.className = 'curriculos-table';

        // Cabeçalho da tabela
        const headerRow = table.insertRow();
        const headers = ['ID', 'Curso', 'Ações'];
        headers.forEach(headerText => {
            const header = document.createElement('th');
            header.textContent = headerText;
            headerRow.appendChild(header);
        });

        // Corpo da tabela (linhas de currículos)
        data.forEach(curriculo => {
            const row = table.insertRow();
            row.className = 'curriculo-row';

            // Colunas da tabela
            const idCell = row.insertCell();
            idCell.textContent = curriculo.curriculo.idCurriculo;

            const cursoCell = row.insertCell();
            cursoCell.textContent = curriculo.curriculo.nomeCurso;

            const cursoMidia = row.insertCell();
            const link = document.createElement('a');
            link.textContent = "Visualizar"; // Texto do link, pode ser alterado conforme necessário
            link.href = 'http://localhost:8080/upload/' + curriculo.curriculo.midia; // Define o href do link
            link.target = "_blank"; // Opcional: abre o link em uma nova aba
            cursoMidia.appendChild(link);

            const actionCell = row.insertCell();
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Excluir';
            deleteButton.addEventListener('click', () => {
                deleteCurriculo(curriculo.curriculo.idCurriculo, curriculo.curriculo.midia);
            });
            actionCell.appendChild(deleteButton);
        });

        alunoDetalhes.appendChild(table);
    }

    function deleteCurriculo(idCurriculo, nomeArquivo) {
        fetch(`http://localhost:8080/api/v1/deleteCurriculo.php?idCurriculo=${idCurriculo}&nomeArquivo=${nomeArquivo}`, {
            method: 'DELETE',
            credentials: 'include'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload()
                } else {
                    alert(data.error);
                }
                console.log('Resposta:', data);
            })
            .catch(error => {
                console.error('Erro ao deletar currículo:', error);
                alert('Erro ao deletar currículo. Por favor, tente novamente.');
            });
    }
</script>